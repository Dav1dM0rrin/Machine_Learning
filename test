"""
SISTEMA DE PREDICCI√ìN POR CONSOLA
Predicci√≥n de pasajeros en sistemas de transporte limpio
Miner√≠a de Datos 2025-2
"""

import numpy as np
import joblib
import sys
from datetime import datetime

# ============================================================================
# CARGAR MODELOS Y TRANSFORMADORES
# ============================================================================

def cargar_modelos():
    """Carga todos los modelos y transformadores necesarios"""
    try:
        print("\n" + "=" * 70)
        print("üöå SISTEMA DE PREDICCI√ìN DE PASAJEROS - TRANSPORTE LIMPIO")
        print("=" * 70)
        print("\nüìÇ Cargando modelos...")
        
        rf_model = joblib.load('random_forest_model.pkl')
        print("  ‚úì Random Forest cargado")
        
        gb_model = joblib.load('gradient_boosting_model.pkl')
        print("  ‚úì Gradient Boosting cargado")
        
        scaler = joblib.load('scaler.pkl')
        print("  ‚úì Scaler cargado")
        
        le_ciudad = joblib.load('le_ciudad.pkl')
        print("  ‚úì Encoder de ciudades cargado")
        
        le_sistema = joblib.load('le_sistema.pkl')
        print("  ‚úì Encoder de sistemas cargado")
        
        print("\n‚úÖ Todos los modelos cargados exitosamente!")
        
        return rf_model, gb_model, scaler, le_ciudad, le_sistema
        
    except FileNotFoundError as e:
        print(f"\n‚ùå Error: No se encontraron los archivos de modelos.")
        print(f"   Detalle: {e}")
        print("\nüí° Soluci√≥n: Primero ejecuta 'python train_models.py' para entrenar los modelos.")
        sys.exit(1)
    except Exception as e:
        print(f"\n‚ùå Error inesperado al cargar modelos: {e}")
        sys.exit(1)

# ============================================================================
# FUNCI√ìN PRINCIPAL DE PREDICCI√ìN
# ============================================================================

def hacer_prediccion_consola(rf_model, gb_model, scaler, le_ciudad, le_sistema):
    """Funci√≥n para realizar predicciones interactivas por consola"""
    
    print("\n" + "=" * 70)
    print("üîÆ SISTEMA DE PREDICCI√ìN INTERACTIVO")
    print("=" * 70)
    print("\nIngresa los datos solicitados para predecir el n√∫mero de pasajeros.")
    
    while True:
        print("\n" + "‚îÄ" * 70)
        print("üìù INGRESO DE DATOS")
        print("‚îÄ" * 70)
        
        try:
            # Selecci√≥n de ciudad
            print("\nüìç CIUDADES DISPONIBLES:")
            ciudades = le_ciudad.classes_
            for i, ciudad in enumerate(ciudades, 1):
                print(f"  {i}. {ciudad}")
            
            while True:
                try:
                    ciudad_idx = int(input(f"\nüëâ Selecciona ciudad (1-{len(ciudades)}): ")) - 1
                    if 0 <= ciudad_idx < len(ciudades):
                        ciudad = ciudades[ciudad_idx]
                        break
                    else:
                        print(f"‚ùå Opci√≥n inv√°lida. Debe ser entre 1 y {len(ciudades)}.")
                except ValueError:
                    print("‚ùå Por favor ingresa un n√∫mero v√°lido.")
            
            # Selecci√≥n de sistema
            print("\nüöå SISTEMAS DE TRANSPORTE DISPONIBLES:")
            sistemas = le_sistema.classes_
            for i, sistema in enumerate(sistemas, 1):
                print(f"  {i}. {sistema}")
            
            while True:
                try:
                    sistema_idx = int(input(f"\nüëâ Selecciona sistema (1-{len(sistemas)}): ")) - 1
                    if 0 <= sistema_idx < len(sistemas):
                        sistema = sistemas[sistema_idx]
                        break
                    else:
                        print(f"‚ùå Opci√≥n inv√°lida. Debe ser entre 1 y {len(sistemas)}.")
                except ValueError:
                    print("‚ùå Por favor ingresa un n√∫mero v√°lido.")
            
            # Datos num√©ricos
            print("\nüìä DATOS OPERACIONALES:")
            print("‚îÄ" * 70)
            
            while True:
                try:
                    variacion = float(input("üëâ Variaci√≥n Transmilenio (-1.0 a 1.0, ej: -0.7): "))
                    if -1.0 <= variacion <= 1.0:
                        break
                    else:
                        print("‚ùå La variaci√≥n debe estar entre -1.0 y 1.0")
                except ValueError:
                    print("‚ùå Por favor ingresa un n√∫mero decimal v√°lido (usa punto, no coma).")
            
            while True:
                try:
                    pasajeros_laboral = int(input("üëâ Pasajeros d√≠a t√≠pico laboral (ej: 3860061): "))
                    if pasajeros_laboral > 0:
                        break
                    else:
                        print("‚ùå Debe ser un n√∫mero positivo.")
                except ValueError:
                    print("‚ùå Por favor ingresa un n√∫mero entero v√°lido.")
            
            while True:
                try:
                    pasajeros_sabado = int(input("üëâ Pasajeros d√≠a s√°bado (ej: 2499019): "))
                    if pasajeros_sabado > 0:
                        break
                    else:
                        print("‚ùå Debe ser un n√∫mero positivo.")
                except ValueError:
                    print("‚ùå Por favor ingresa un n√∫mero entero v√°lido.")
            
            while True:
                try:
                    pasajeros_festivo = int(input("üëâ Pasajeros d√≠a festivo (ej: 1188607): "))
                    if pasajeros_festivo > 0:
                        break
                    else:
                        print("‚ùå Debe ser un n√∫mero positivo.")
                except ValueError:
                    print("‚ùå Por favor ingresa un n√∫mero entero v√°lido.")
            
            # D√≠a de la semana
            print("\nüìÖ D√çA DE LA SEMANA:")
            print("  1=Lunes | 2=Martes | 3=Mi√©rcoles | 4=Jueves")
            print("  5=Viernes | 6=S√°bado | 7=Domingo")
            
            while True:
                try:
                    dia_semana = int(input("\nüëâ Selecciona d√≠a (1-7): "))
                    if 1 <= dia_semana <= 7:
                        break
                    else:
                        print("‚ùå Debe ser un n√∫mero entre 1 y 7.")
                except ValueError:
                    print("‚ùå Por favor ingresa un n√∫mero v√°lido.")
            
            # Fecha
            print("\nüìÜ FECHA DE PREDICCI√ìN:")
            fecha_valida = False
            while not fecha_valida:
                try:
                    a√±o = int(input("üëâ A√±o (ej: 2024): "))
                    mes = int(input("üëâ Mes (1-12): "))
                    dia = int(input("üëâ D√≠a (1-31): "))
                    
                    # Validar fecha
                    datetime(a√±o, mes, dia)
                    fecha_valida = True
                except ValueError:
                    print("‚ùå Fecha inv√°lida. Intenta de nuevo.")
            
            # ================================================================
            # REALIZAR PREDICCI√ìN
            # ================================================================
            
            print("\n" + "‚îÄ" * 70)
            print("‚öôÔ∏è  Procesando predicci√≥n...")
            print("‚îÄ" * 70)
            
            # Preparar datos
            ciudad_encoded = le_ciudad.transform([ciudad])[0]
            sistema_encoded = le_sistema.transform([sistema])[0]
            
            input_features = np.array([[
                ciudad_encoded,
                sistema_encoded,
                variacion,
                pasajeros_laboral,
                pasajeros_sabado,
                pasajeros_festivo,
                dia_semana,
                a√±o,
                mes,
                dia
            ]])
            
            input_scaled = scaler.transform(input_features)
            
            # Predicciones
            pred_rf = rf_model.predict(input_scaled)[0]
            pred_gb = gb_model.predict(input_scaled)[0]
            pred_promedio = (pred_rf + pred_gb) / 2
            
            # ================================================================
            # MOSTRAR RESULTADOS
            # ================================================================
            
            print("\n" + "=" * 70)
            print("üìä RESULTADOS DE LA PREDICCI√ìN")
            print("=" * 70)
            
            # Resumen de entrada
            print("\nüìã RESUMEN DE DATOS INGRESADOS:")
            print("‚îÄ" * 70)
            print(f"  üèôÔ∏è  Ciudad:                   {ciudad}")
            print(f"  üöå Sistema:                   {sistema}")
            print(f"  üìâ Variaci√≥n Transmilenio:    {variacion:.3f}")
            print(f"  üëî Pasajeros d√≠a laboral:     {pasajeros_laboral:>12,}")
            print(f"  üõçÔ∏è  Pasajeros s√°bado:          {pasajeros_sabado:>12,}")
            print(f"  üéâ Pasajeros festivo:         {pasajeros_festivo:>12,}")
            
            dias_texto = {
                1: 'Lunes', 2: 'Martes', 3: 'Mi√©rcoles', 4: 'Jueves',
                5: 'Viernes', 6: 'S√°bado', 7: 'Domingo'
            }
            print(f"  üìÖ D√≠a de la semana:          {dias_texto[dia_semana]}")
            print(f"  üìÜ Fecha:                     {dia:02d}/{mes:02d}/{a√±o}")
            
            # Predicciones
            print("\nüéØ PREDICCIONES DE PASAJEROS:")
            print("‚îÄ" * 70)
            print(f"  üå≤ Random Forest:             {pred_rf:>12,.0f} pasajeros")
            print(f"  üöÄ Gradient Boosting:         {pred_gb:>12,.0f} pasajeros")
            print(f"  üìä Promedio (recomendado):    {pred_promedio:>12,.0f} pasajeros")
            
            # An√°lisis de confianza
            diff_percent = abs(pred_rf - pred_gb) / pred_promedio * 100
            print(f"\nüìà AN√ÅLISIS DE CONFIANZA:")
            print("‚îÄ" * 70)
            print(f"  Diferencia entre modelos: {diff_percent:.2f}%")
            
            if diff_percent < 3:
                print("  ‚úÖ Excelente: Ambos modelos est√°n muy alineados.")
                print("  üéØ Nivel de confianza: MUY ALTO")
            elif diff_percent < 7:
                print("  ‚úÖ Bueno: Diferencia aceptable entre modelos.")
                print("  üéØ Nivel de confianza: ALTO")
            elif diff_percent < 15:
                print("  ‚ö†Ô∏è  Moderado: Hay variaci√≥n entre los modelos.")
                print("  üéØ Nivel de confianza: MEDIO")
            else:
                print("  ‚ùå Significativo: Gran diferencia entre modelos.")
                print("  üéØ Nivel de confianza: BAJO")
                print("  üí° Considera revisar los datos ingresados.")
            
            # Rangos de predicci√≥n
            print(f"\nüìä RANGO DE PREDICCI√ìN:")
            print("‚îÄ" * 70)
            rango_min = min(pred_rf, pred_gb)
            rango_max = max(pred_rf, pred_gb)
            print(f"  M√≠nimo esperado: {rango_min:>12,.0f} pasajeros")
            print(f"  M√°ximo esperado: {rango_max:>12,.0f} pasajeros")
            print(f"  Rango total:     {rango_max - rango_min:>12,.0f} pasajeros")
            
            print("\n" + "=" * 70)
            
        except KeyboardInterrupt:
            print("\n\nüëã Predicci√≥n cancelada por el usuario.")
            break
        except Exception as e:
            print(f"\n‚ùå Error durante la predicci√≥n: {e}")
            print("üí° Por favor verifica los datos ingresados e intenta nuevamente.")
            continue
        
        # Preguntar si desea hacer otra predicci√≥n
        print("\n" + "‚îÄ" * 70)
        while True:
            otra = input("¬øDeseas hacer otra predicci√≥n? (s/n): ").lower().strip()
            if otra in ['s', 'si', 's√≠', 'n', 'no']:
                break
            print("‚ùå Por favor responde 's' o 'n'")
        
        if otra not in ['s', 'si', 's√≠']:
            print("\n" + "=" * 70)
            print("üëã ¬°Gracias por usar el sistema de predicci√≥n!")
            print("=" * 70)
            break

# ============================================================================
# PROGRAMA PRINCIPAL
# ============================================================================

def main():
    """Funci√≥n principal del programa"""
    
    # Cargar modelos
    rf_model, gb_model, scaler, le_ciudad, le_sistema = cargar_modelos()
    
    # Iniciar sistema de predicci√≥n
    hacer_prediccion_consola(rf_model, gb_model, scaler, le_ciudad, le_sistema)
    
    print("\nüéâ PROGRAMA FINALIZADO")
    print("\nüí° Tambi√©n puedes usar la aplicaci√≥n web ejecutando:")
    print("   streamlit run app.py\n")

if __name__ == "__main__":
    main()